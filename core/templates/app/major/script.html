<script>
  const form = document.querySelector('#form-major');
  const url = `{% url "major_form" %}`;

  async function validatingInput(input) {
    if (input.value === 'undefined' || input.value === null || input.value === '') {
      input.style.borderColor = 'red';
      return false;
    }
    
    return input.value;
  }

  document.addEventListener('DOMContentLoaded', async () => {

    const bubble = document.querySelector('a.label');
    if (bubble) {
      setTimeout(() => {
        let opacity = 1;
        let timer = setInterval(() => {
          if (opacity <= 0.1) {
            clearInterval(timer);
            bubble.style.display = 'none';
          }
          bubble.style.opacity = opacity;
          bubble.style.filter = `alpha(opacity=${opacity * 100})`;
          opacity -= opacity * 0.1;
        }, 100);
      }, 2000);
    }

    const editButton = document.querySelectorAll('.selectRecord');
    [... editButton].forEach(element => {
      element.addEventListener('click', async (event) => {
        event.preventDefault();
        let url = await event.target.href;
        let request = await fetch(url).then(res => res.json());
        document.querySelector('input#primary_key').value = request.id;
        document.querySelector('input#code').value = request.code;
        document.querySelector('input#name').value = request.name;
        document.querySelector('textarea#description').innerText = request.desc;
      });
    });

    form.addEventListener('submit', async(event) => {
      event.preventDefault();
      
      let endpoint = url;
      let id = await validatingInput(event.target[1]);
      let code = await validatingInput(event.target[2]);
      let name = await validatingInput(event.target[3]);
      let description = await validatingInput(event.target[4]);

      if (code === false || name === false || description === false){
        console.log('Input field is mandatory!');
        return false;
      }

      const data = new FormData();
      data.append('csrfmiddlewaretoken', await event.target[0].value);
      data.append('code', code);
      data.append('name', name);
      data.append('description', description);

      if (id) {
        endpoint = `${endpoint}${id}`;
      }
      fetch(endpoint, {
        method: 'POST',
        body: data
      }).then(response => {
        if (response.status === 201) {
          location.reload();
        }
      }).catch(error => {
        console.error(error);
      });
    });
  });

</script>